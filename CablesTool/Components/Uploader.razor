
@using System.IO
@using Microsoft.Extensions.Logging
@using CablesTool.Data
@using CablesTool.Services
@using System.Threading
@using Utils
@using Xabe.FFmpeg

<div class="border">
    <p>
        Upload:
    </p>
    <div class="in-border">
        <div class="left-to-right-container">
            <p>
                <div class="input-group">
                    <div class="custom-file">
                        <Microsoft.AspNetCore.Components.Forms.InputFile OnChange="@LoadFiles"
                                                                         type="file"
                                                                         class="custom-file-input"
                                                                         id="inputGroupFile04"
                                                                         aria-describedby="inputGroupFileAddon04">
                        </Microsoft.AspNetCore.Components.Forms.InputFile>
                        <label class="custom-file-label" for="inputGroupFile">Choose video</label>
                    </div>
                </div>
            </p>
            @if (isLoading)
            {
                <div class="progress" style="width: 300px">
                    <div class="progress-bar" role="progressbar" style="@($"width: {progressValue}%")" aria-valuenow="@progressValue" aria-valuemin="0" aria-valuemax="100">@progressValue %</div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Inject]
    public ILogger<Uploader> Logger { get; set; }
    [Inject]
    public ApplicationContext ApplicationContext { get; set; }
    [Inject]
    public IJSRuntime JS { get; set; }
    [Inject]
    public UploadEvents<long> UploadEvents { get; set; }
    [Parameter]
    public string FolderName { get; set; }
    public string VideoName;
    private CancellationTokenSource cts;

    private long maxFileSizeBytes = 1024 * 1024 * 1000;
    public long MaxFileSizeKb
    {
        get => maxFileSizeBytes / 1024;
    }
    private IBrowserFile loadedFile;
    private int progressValue = 0;
    private bool isLoading = false;

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        var videoFile = ApplicationContext.VideoFiles.FirstOrDefault(file => file.Name == e.File.Name);
        try
        {
            string filePath = AppDomain.CurrentDomain.BaseDirectory + "wwwroot/CablesProject/" + e.File.Name;
            Logger.LogInformation(e.File.Name);
            if (videoFile == null)
            {
                await WriteFile(filePath, e);
                var currentId = await SaveToDatabase(filePath, e);
                isLoading = false;
                await UploadEvents.UploadFile(currentId);
            }
            else
            {
                await UploadEvents.UploadFile(videoFile.Id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex.ToString());
        }

        isLoading = false;
        progressValue = 0;
    }

    private async Task WriteFile(string filePath, InputFileChangeEventArgs e)
    {
        cts = new CancellationTokenSource();
        await using (FileStream output = new(filePath, FileMode.OpenOrCreate, FileAccess.Write, FileShare.None))
        {

            var input = e.File.OpenReadStream(maxFileSizeBytes, cts.Token);//.CopyToAsync(streamTo);
            int read;
            double inputLength = input.Length;
            double currentLength = 0;
            var buffer = new byte[1024 * 16];

            while ((read = await input.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await output.WriteAsync(buffer, 0, read);
                currentLength += read;
                progressValue = Convert.ToInt32(currentLength / inputLength * 100d);
                StateHasChanged();
                Logger.LogWarning($"Uploading {e.File.Name}: {progressValue.ToString()}");
            }
        }

        File.SetAttributes(filePath, FileAttributes.Normal);
        Logger.LogInformation($"{filePath} uploaded.");

    }

    private async Task<long> SaveToDatabase(string filePath, InputFileChangeEventArgs e)
    {
        TimeSpan videoLength = await GetVideoLength(filePath);

        VideoFileEntity videoFileEntity = new()
        {
            Name = e.File.Name,
            Path = filePath,
            Length = Math.Round( videoLength.TotalSeconds, 0)
        };

        ApplicationContext.VideoFiles.Add(videoFileEntity);
        await ApplicationContext.SaveChangesAsync();
        Logger.LogInformation($"{filePath} metadata saved to Db.");

        return ApplicationContext.VideoFiles.FirstOrDefault(v => v.Name == videoFileEntity.Name).Id;

    }

    private async Task<TimeSpan> GetVideoLength(string filePath)
    {
        IMediaInfo mediaInfo = await FFmpeg.GetMediaInfo(filePath);
        var videoDuration = mediaInfo.VideoStreams.First().Duration;
        return videoDuration;
    }

}
